

todo = [
        {'src_file': './linear_interpolators.h',
         'out_file': '../src_autogenerated/linear_interpolators_cpu.c',
         'context': 'cpu',
        },
        {'src_file': './linear_interpolators.h',
         'out_file': '../src_autogenerated/linear_interpolators_opencl.clh',
         'context': 'opencl',
        },
        {'src_file': './linear_interpolators.h',
         'out_file': '../src_autogenerated/linear_interpolators_cuda.cu',
         'context': 'cuda',
        },
    ]

for job in todo:

    fname = job['src_file']
    newfname = job['out_file']
    context = job['context']

    assert context in ['cpu', 'opencl', 'cuda']

    with open(fname, 'r') as fid:
        lines = fid.readlines()

    indent = True
    new_lines = []
    inside_vect_block = False
    for ii, ll in enumerate(lines):
        if '//vectorize_over' in ll:
            if inside_vect_block:
                raise ValueError(
                        f'Line {ii}: Previous vect block not closed!')
            inside_vect_block = True
            varname, limname = ll.split('//vectorize_over')[-1].split()
            if context == 'cpu':
                new_lines.append(f'int {varname}; //autovectorized\n')
                new_lines.append(
                    f'for ({varname}=0; {varname}<{limname}; {varname}++)'
                    +'{ //autovectorized\n')
            elif context == 'opencl':
                new_lines.append(f'int {varname}; //autovectorized\n')
                new_lines.append(
                    f'{varname}=get_global_id(0); //autovectorized\n')
            elif context == 'cuda':
                new_lines.append(f'int {varname}; //autovectorized\n')
                new_lines.append(
                    f'{varname}=blockDim.x * blockIdx.x + threadIdx.x;'
                      '//autovectorized\n')
        elif '//end_vectorize' in ll:
            if context == 'cpu':
                new_lines.append('}//end autovectorized\n')
            elif context == 'opencl':
                new_lines.append('//end autovectorized\n')
            elif context == 'cuda':
                new_lines.append('//end autovectorized\n')

            inside_vect_block = False
        else:
            if '//only_for_context' in ll:
                ptemp = ll.split(
                    '//only_for_context')[-1].split()[0].strip()
                if context != ptemp:
                    ll = '//' + ll
            if indent and inside_vect_block:
                new_lines.append('    ' + ll)
            else:
                new_lines.append(ll)

    newfilecontent = ''.join(new_lines)
    newfilecontent = newfilecontent.replace('/*gpukern*/',
        {'cpu':' ', 'opencl': ' __kernel ', 'cuda': '__global__'}[context])
    newfilecontent = newfilecontent.replace('/*gpuglmem*/',
        {'cpu':' ', 'opencl': ' __global ', 'cuda': ' '}[context])

    with open(newfname, 'w') as fid:
        fid.write(newfilecontent)
